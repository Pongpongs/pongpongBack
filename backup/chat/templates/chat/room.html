<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Chat Room</title>
	</head>
	<body>
		<textarea id="chat-log" cols="100" rows="20"></textarea><br>
		<input id="chat-message-input" type="text" size="100"><br>
		<input id="chat-message-submit" type="button" value="Send">
		{{ room_name|json_script:"room-name" }}
		<script>
			const roomName = JSON.parse(document.getElementById('room-name').textContent);
			const wsScheme = window.location.protocol == "https:" ? "wss" : "ws";
			const publicIp = "43.200.228.128";
			const chatSocket = new WebSocket(
				`${wsScheme}://${publicIp}/ws/chat/${roomName}/`
			);
			// 채팅창 - 채팅 내역 출력
			chatSocket.onmessage = function(event) {
				const data = JSON.parse(event.data);
				document.querySelector('#chat-log').value += (data.message + '\n');
			};
			// 웹 소켓 강제 종료시 에러 처리 - 에러 로그 출력
			chatSocket.onclose = function(event) {
				console.error('chat socket closed unexpectedly');
			};
			document.querySelector('#chat-message-input').focus();
			document.querySelector('#chat-message-input').onkeyup = function(event) {
				if (event.key === 'Enter') {
					document.querySelector('#chat-message-submit').click();
				}
			};

			document.querySelector('#chat-message-submit').onclick = function(event) {
				const messageInputDom = document.querySelector('#chat-message-input');
				const message = messageInputDom.value;
				chatSocket.send(JSON.stringify({
					'message': message
				}));
				messageInputDom.value = '';
			};
		</script>
	</body>
</html>