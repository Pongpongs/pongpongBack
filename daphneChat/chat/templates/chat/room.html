{% load static %}


<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Chat Room</title>
		<script type="importmap">
			{
					"imports": {
							"three": "https://unpkg.com/three@0.160.0/build/three.module.js",
							"three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
					}
			}
		</script>
		<script type="module" src="{% static 'js/remoteGame.js' %}" defer></script>

	</head>
	<body>
		
		{{ room_name|json_script:"room-name" }}
		<script>
			const roomName = JSON.parse(document.getElementById('room-name').textContent);
			const wsScheme = window.location.protocol == "https:" ? "wss" : "ws";
			
			var barPositions = {
            bar1: {x: 0, y:0},
            bar2: {x: 0, y:0}
      };
        
      var scoreBoard = {p1 : 0, p2: 0}
      var ballPosition = {x:0, y:0};
		
			
			const chatSocket = new WebSocket(
				`${wsScheme}://${window.location.host}/ws/chat/${roomName}/`
			);


			document.addEventListener('keydown', function(event) {
            const keyName = event.key;
            console.log('keydown event\n\n' + 'key: ' + keyName );

            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'message': keyName
                }));
            }
      });

			// 채팅창 - 채팅 내역 출력
			chatSocket.onmessage = function(event)	{
				const data = JSON.parse(event.data);


				if (data.play_bar1_position !== undefined) {
        	console.log('Position: ' + data.play_bar1_position); // 좌표 로깅
          barPositions.bar1.x = data.play_bar1_position.x;
          barPositions.bar1.y = data.play_bar1_position.y;
                
        }
        if (data.play_bar2_position !== undefined) {
          console.log('Position: ' + data.play_bar2_position); // 좌표 로깅
          barPositions.bar2.x = data.play_bar2_position.x;
          barPositions.bar2.y = data.play_bar2_position.y;
        }
        if (data.ball_position !== undefined) {
          console.log('Ball Position: ', data.ball_position);
          ballPosition.x = data.ball_position.x;
          ballPosition.y = data.ball_position.y;
        }
        if (data.score_player1 !== undefined && data.score_player2 !== undefined) {
          document.getElementById('scorePlayer1').innerText = data.score_player1;
          document.getElementById('scorePlayer2').innerText = data.score_player2;
				}
				
			};

			// 웹 소켓 강제 종료시 에러 처리 - 에러 로그 출력
			chatSocket.onclose = function(event) {
				console.error('chat socket closed unexpectedly');
			};


			document.querySelector('#chat-message-input').focus();
			document.querySelector('#chat-message-input').onkeyup = function(event) {
				if (event.key === 'Enter') {
					document.querySelector('#chat-message-submit').click();
				}
			};

			document.querySelector('#chat-message-submit').onclick = function(event) {
				const messageInputDom = document.querySelector('#chat-message-input');
				const message = messageInputDom.value;
				chatSocket.send(JSON.stringify({
					'message': message
				}));
				messageInputDom.value = '';
			};			//여기는 나중가선 지우기
			
		</script>
		<div id="scoreBoard" style="text-align: center; margin-bottom: 20px;">
				Player 1: <span id="scorePlayer1">0</span> | 
				Player 2: <span id="scorePlayer2">0</span>
		</div>

		<div id="gameContainer" style="width: 800px; height: 100px; margin: auto;"></div>

	</body>
</html>